# API Gateway for AI Content Generation

The API Gateway system provides reliable content generation through multiple AI providers with automatic fallback and monitoring.

## Architecture

### Provider Priorities

#### For text content:
1. **DirectProvider** - Direct connection to AI services (highest priority)
2. **DirectProvider** - Fallback to alternative endpoints

#### For images:
1. **NetlifyProvider** - Image generation via Netlify Functions (primary)

### Fallback Logic

1. **Provider level**: On provider failure, move to the next priority provider
2. **Model level**: Within each provider, fallback between models
3. **Cooldown system**: Failed models are temporarily excluded from rotation

## Components

### Core Classes

- `APIGateway` - Main class with fallback logic
- `BaseProvider` - Base class for all providers
- `DirectProvider` - Provider for direct API calls
- `NetlifyProvider` - Provider for image generation

### Data Models

- `APIRequest` - Request to API Gateway
- `APIResponse` - Response from API Gateway
- `ProviderConfig` - Provider configuration
- `ModelConfig` - Model configuration

### Utilities

- `HealthChecker` - Provider health monitoring
- `MetricsCollector` - Performance metrics collection

## Configuration

### Environment Variables

```bash
# API keys
GEMINI_API_KEY=your_gemini_key
GROQ_API_KEY=your_groq_key
OPENROUTER_API_KEY=your_openrouter_key
TOGETHER_API_KEY=your_together_key

# Direct connection
USE_DIRECT_WORKERS=true
NETLIFY_BASE_URL=https://your-app.netlify.app/.netlify/functions
```

## Usage

### Basic Usage

```python
from app.services.api_gateway import APIGateway
from app.services.api_gateway.models import ContentType

# Initialize
gateway = APIGateway()

# Generate text
response = await gateway.generate_content(
    endpoint="lesson-plan",
    data={"prompt": "Create a lesson about English grammar"},
    api_keys={"gemini": "your_key"},
    content_type=ContentType.TEXT
)

if response.success:
    print(f"Generated by {response.provider_name}/{response.model_name}")
    print(response.content)
```

### Via ContentGenerator

```python
from app.services.content.content_generator_core import ContentGenerator

async with ContentGenerator(db_session) as generator:
    content = await generator.generate_content_via_gateway(
        prompt="Create a lesson plan",
        content_type=ContentType.LESSON_PLAN
    )
```

## API Endpoints

### Monitoring

- `GET /api/v1/api-gateway/health` - Provider health status
- `GET /api/v1/api-gateway/stats` - Usage statistics
- `GET /api/v1/api-gateway/providers` - Provider information
- `GET /api/v1/api-gateway/metrics` - Detailed metrics

### Testing

- `POST /api/v1/api-gateway/test` - Test generation

### Management

- `POST /api/v1/api-gateway/cleanup` - Resource cleanup
- `GET /api/v1/api-gateway/config` - System configuration

## Monitoring and Metrics

### Health Check

The system automatically checks provider health:

- API endpoint availability
- Response time
- Number of available models

### Metrics

Collected metrics:

- Total request count
- Success rate by provider
- Average response time
- Token usage
- Model popularity
- Error types

### Cooldown System

On errors, models are automatically put in cooldown:

- Rate limiting: 10 minutes
- Server errors: 5 minutes
- Timeout: 3 minutes

## Troubleshooting

### Common Issues

1. **All providers unavailable**
   - Check API keys
   - Check network connection
   - Check service status

2. **High response time**
   - Check provider load
   - Consider increasing timeout
   - Check network quality

### Logging

Logs available in categories:

- `api_gateway` - Main logic
- `direct_provider` - Direct provider
- `netlify_provider` - Netlify provider
- `health_checker` - Health monitoring
- `metrics_collector` - Metrics collection

## Development

### Adding a New Provider

1. Inherit from `BaseProvider`
2. Implement `_call_model_api` and `_health_check_implementation`
3. Add configuration in `config.py`
4. Register in `APIGateway`

### Testing

```bash
# Run tests
pytest backend/tests/services/api_gateway/

# Test specific provider
pytest backend/tests/services/api_gateway/test_direct_provider.py
```

## Security

- API keys passed via headers
- Logs don't contain sensitive data
- All endpoints require authentication
