# Детализация плана урока

## Описание проблемы

При генерации детализированной информации для плана урока (скрипт учителя, домашнее задание, упражнения, игры) возникала проблема: сгенерированный контент не соответствовал теме исходного плана урока. 

Например:
- Исходный план урока на тему "Технологии в современном образовании"
- Сгенерированный скрипт учителя содержал информацию об истории искусства

Также наблюдалась следующая проблема: система не учитывала формат занятия (индивидуальный/групповой) и тип проведения (онлайн/оффлайн) при генерации детализированного контента.

## Решение

Было создано специализированное решение для компонента плана урока:

1. Создан новый сервис `lessonPlanDetailService.ts`, который:
   - Принимает полное содержимое исходного плана урока
   - Явно передает тему плана урока (`lesson_focus`) в запросе к API
   - Добавляет специальные инструкции в поле `action` для сохранения тематического фокуса
   - Обеспечивает более детальное логирование процесса и валидацию ответов

2. Добавлена система анализа плана урока:
   - Добавлена функция `extractParamsFromPlan`, которая извлекает параметры из текста плана урока
   - Добавлена функция `mergeAndValidateParams`, которая объединяет параметры из формы с параметрами из плана
   - Определены дефолтные значения для отсутствующих параметров

3. Добавлены специализированные методы для различных типов контента:
   - `detailLessonPlanScript` - скрипт учителя
   - `detailLessonPlanHomework` - домашнее задание
   - `detailLessonPlanExercises` - упражнения
   - `detailLessonPlanGame` - игра
   - `detailLessonPlanPoint` - детализация конкретного пункта плана

4. Модифицирован компонент `LessonPlan.vue` для использования нового сервиса:
   - Добавлен механизм отказоустойчивости с автоматическим переключением на предыдущий метод в случае ошибки
   - Улучшено логирование процесса для упрощения отладки
   - Сохранен интерфейс и взаимодействие с пользователем

## Техническая реализация

### Система извлечения параметров из плана урока

Система автоматически анализирует текст плана урока и извлекает из него параметры:

```typescript
export function extractParamsFromPlan(planContent: string): {
  language?: string;
  topic?: string;
  age?: string;
  methodology?: string;
  individual_group?: string;
  online_offline?: string;
  duration?: number;
  level?: string;
} {
  // Извлечение параметров из текста плана с помощью регулярных выражений
  // ...
}
```

### Приоритет параметров

Система устанавливает следующие приоритеты для определения итоговых параметров:

1. Параметры, явно указанные пользователем в форме
2. Параметры, извлеченные из текста плана урока
3. Дефолтные значения

Дефолтные значения:
```typescript
const defaults = {
  language: 'English',
  age: 'teens',
  methodology: '',
  individual_group: 'individual',
  online_offline: 'online',
  duration: 60,
  level: 'intermediate'
};
```

### Структура запроса к API

```typescript
// Формат запроса детализации
interface LessonPlanDetailRequest {
  content: string           // Содержимое плана урока
  content_type: string      // Тип детализации (teacher_script, homework, exercises, game)
  language: string          // Язык плана урока
  lesson_focus: string      // Тема урока
  age_group?: string        // Возрастная группа
  methodology?: string      // Методология
  is_individual?: boolean   // Индивидуальное или групповое занятие
  is_online?: boolean       // Онлайн или офлайн занятие
  duration?: number         // Продолжительность урока в минутах
  level?: string            // Уровень владения языком
  action?: string           // Текст инструкции для генератора
  instruction_language?: string // Язык инструкции
}
```

### Ключевые улучшения в запросе к API

1. **Явная передача темы**:
   ```typescript
   lesson_focus: validatedParams.topic, // Явно передаем тему урока
   ```

2. **Явное указание формата занятия в инструкции**:
   ```typescript
   action: `ВАЖНО: Это запрос на создание скрипта учителя для плана урока на тему "${validatedParams.topic}"...
   
   ОБРАТИ ВНИМАНИЕ: Это ${validatedParams.individual_group === 'individual' ? 'ИНДИВИДУАЛЬНОЕ' : 'ГРУППОВОЕ'} 
   занятие в формате ${validatedParams.online_offline === 'online' ? 'ОНЛАЙН' : 'ОФФЛАЙН'}.
   Адаптируй скрипт именно под ${validatedParams.individual_group === 'individual' ? 
   'работу с одним учеником' : 'работу с группой учеников'}...`,
   ```

3. **Явное указание языка результата**:
   ```typescript
   instruction_language: validatedParams.language // Явно указываем язык выходного контента
   ```

## Контрольный лист проверки

После внедрения решения необходимо проверить:

1. Соответствие генерируемого контента теме урока для всех типов детализации
2. Корректность работы механизма отказоустойчивости
3. Сохранение лимитов генерации и корректные проверки
4. Логирование всех этапов процесса для упрощения отладки
5. Обработку различных форматов ответов от API
6. **НОВОЕ:** Корректное определение и учет формата занятия (индивидуальный/групповой)
7. **НОВОЕ:** Корректное определение и учет типа проведения (онлайн/оффлайн)
8. **НОВОЕ:** Корректную работу с дефолтными параметрами при отсутствии явно указанных

## Дальнейшие улучшения

В будущем можно рассмотреть следующие улучшения:

1. Добавление механизма кэширования результатов детализации для улучшения производительности
2. Расширение типов детализации (оценивание, материалы для проверки знаний, презентации)
3. Улучшение анализа исходного плана для более точной интеграции результатов детализации
4. Добавление возможности редактирования сгенерированных деталей до их сохранения
5. **НОВОЕ:** Улучшение алгоритмов извлечения параметров из планов урока с нестандартным форматированием
6. **НОВОЕ:** Добавление интерфейса для ручной корректировки автоматически определенных параметров 